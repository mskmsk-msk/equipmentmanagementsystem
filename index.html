<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비품관리 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', '맑은 고딕', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 3px solid #34495e;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .header h1 {
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .header p {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .data-management-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            padding: 20px;
            margin-top: 20px;
            align-items: start;
        }

        .data-management-2col h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .backup-btns {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .category-adder {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .category-adder input {
            flex: 1;
            padding: 8px;
            border: 2px solid #bdc3c7;
            font-size: 0.9rem;
        }

        .company-info {
            background: white;
            border: 2px solid #34495e;
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
            justify-content: end;
        }

        .company-info div {
            padding: 5px;
        }

        .company-info strong {
            color: #2c3e50;
        }

        .section {
            background: white;
            margin: 20px 0;
            border: 2px solid #34495e;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        .section-header {
            background-color: #34495e;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2c3e50;
        }

        .section-header h2 {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .section-content {
            padding: 20px;
        }

        .btn {
            background-color: #34495e;
            color: white;
            border: 1px solid #2c3e50;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2c3e50;
        }

        .btn-success {
            background-color: #27ae60;
            border-color: #229954;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            border-color: #c0392b;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .btn-um {
            font-size: 0.75rem;
            padding: 3px 6px;
            line-height: 1.2;
            min-width: auto;
            height: auto;
            border-radius: 4px;
        }

        .backup-btns-um {
            gap: 6px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px;
            border: 2px solid #bdc3c7;
            font-size: 0.9rem;
            background-color: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #3498db;
            outline: none;
        }

        .search-filter {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
        }

        .search-filter input,
        .search-filter select {
            padding: 8px;
            border: 2px solid #bdc3c7;
            font-size: 0.9rem;
        }

        .table-container {
            border: 2px solid #34495e;
            overflow-x: auto;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            font-size: 0.8rem;
        }

        th {
            background-color: #95a5a6;
            color: #2c3e50;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #7f8c8d;
            font-size: 0.8rem;
        }

        td {
            padding: 10px 8px;
            border: 1px solid #bdc3c7;
            text-align: center;
            font-size: 0.8rem;
            background-color: white;
        }

        tr:nth-child(even) td {
            background-color: #f8f9fa;
        }

        tr:hover td {
            background-color: #e8f4fd;
        }

        .status-good { 
            background-color: #d5f4e6 !important;
            color: #27ae60;
            font-weight: bold;
            border: 1px solid #27ae60;
            padding: 3px 6px;
        }

        .status-fair { 
            background-color: #fff3cd !important;
            color: #f39c12;
            font-weight: bold;
            border: 1px solid #f39c12;
            padding: 3px 6px;
        }

        .status-poor { 
            background-color: #fadbd8 !important;
            color: #e74c3c;
            font-weight: bold;
            border: 1px solid #e74c3c;
            padding: 3px 6px;
        }

        .action-btns {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            border: 3px solid #34495e;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            background-color: #34495e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            color: #bdc3c7;
        }

        .modal-body {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border: 2px solid #34495e;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            display: block;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        .backup-section {
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            padding: 15px;
            margin-top: 20px;
        }

        .backup-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .backup-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .search-filter {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 0.7rem;
            }
            
            .company-info {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            body { background-color: white; }
            .section { border: 1px solid #000; }
            .btn, .modal, .backup-section { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>비 품 관 리 시 스 템</h1>
        <p>EQUIPMENT MANAGEMENT SYSTEM</p>
    </div>

    <div class="container">
        <!-- 회사 정보 -->
        <div class="company-info">
            <div><strong>회사명:</strong> <span id="companyName">시점엔지니어링</span></div>
            <div><strong>담당자:</strong> <span id="manager">관리팀 염우선</span></div>
        </div>

        <!-- 통계 -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="totalEquipment">0</span>
                <div class="stat-label">총 비품 수</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="goodCondition">0</span>
                <div class="stat-label">정상 비품</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="needMaintenance">0</span>
                <div class="stat-label">점검 필요</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalValue">0</span>
                <div class="stat-label">총 자산가치 (만원)</div>
            </div>
        </div>

        <!-- 비품 관리 -->
        <div class="section">
            <div class="section-header">
                <h2>■ 비품 현황 관리</h2>
                <button class="btn btn-success" onclick="openModal('equipmentModal')">
                    ＋ 새 비품 등록
                </button>
            </div>
            <div class="section-content">
                <!-- 검색 및 필터 -->
                <div class="search-filter">
                    <input type="text" id="searchInput" placeholder="비품명, 모델명으로 검색..." onkeyup="filterEquipment()">
                    <select id="categoryFilter" onchange="filterEquipment()">
                        <option value="">전체 분류</option>
                        <option value="전자기기">전자기기</option>
                        <option value="사무기기">사무기기</option>
                        <option value="가구">가구</option>
                        <option value="소모품">소모품</option>
                    </select>
                    <select id="statusFilter" onchange="filterEquipment()">
                        <option value="">전체 상태</option>
                        <option value="양호">양호</option>
                        <option value="보통">보통</option>
                        <option value="불량">불량</option>
                        <option value="고장">고장</option>
                    </select>
                    <button class="btn" onclick="printTable()">인쇄</button>
                </div>

                <!-- 비품 테이블 -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>순번</th>
                                <th>비품번호</th>
                                <th>분류</th>
                                <th>품목명</th>
                                <th>모델/규격</th>
                                <th>수량</th>
                                <th>구입일자</th>
                                <th>구입가격</th>
                                <th>사용부서</th>
                                <th>사용자</th>
                                <th>위치</th>
                                <th>상태</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentTableBody">
                            <tr>
                                <td colspan="13" class="empty-state">
                                    등록된 비품이 없습니다. 새 비품을 등록해주세요.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 대여 관리 -->
        <div class="section">
            <div class="section-header">
                <h2>■ 대여 및 반납 관리</h2>
                <button class="btn btn-success" onclick="openModal('rentalModal')">
                    ＋ 새 대여 등록
                </button>
            </div>
            <div class="section-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>순번</th>
                                <th>대여번호</th>
                                <th>비품번호</th>
                                <th>품목명</th>
                                <th>대여자</th>
                                <th>부서</th>
                                <th>대여일자</th>
                                <th>반납예정일</th>
                                <th>실제반납일</th>
                                <th>상태</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody id="rentalTableBody">
                            <tr>
                                <td colspan="11" class="empty-state">
                                    등록된 대여 기록이 없습니다.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 데이터 백업/복원 -->
        <div class="data-management-2col">
            <div class="left">
                <h4>📁 데이터 관리</h4>
                <div class="backup-btns-um">
                    <button class="btn" onclick="exportData()">데이터 내보내기 (JSON)</button>
                    <button class="btn" onclick="document.getElementById('importFile').click()">데이터 가져오기</button>
                    <button class="btn btn-danger" onclick="clearAllData()">전체 데이터 삭제</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
            </div>

            <div class="right">
                <h4>➕ 새 분류 추가</h4>
                <div class="category-adder">
                    <input type="text" id="newCategory" placeholder="예: 네트워크장비">
                    <button class="btn btn-sm" onclick="addCategory()">추가</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 비품 등록/수정 모달 -->
    <div id="equipmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="equipmentModalTitle">새 비품 등록</h3>
                <button class="close" onclick="closeModal('equipmentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="equipmentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="equipmentCode">비품번호 *</label>
                            <input type="text" id="equipmentCode" required>
                        </div>
                        <div class="form-group">
                            <label for="category">분류 *</label>
                            <select id="category" required>
                                <option value="">선택하세요</option>
                                <option value="전자기기">전자기기</option>
                                <option value="사무기기">사무기기</option>
                                <option value="가구">가구</option>
                                <option value="소모품">소모품</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemName">품목명 *</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label for="model">모델/규격</label>
                            <input type="text" id="model">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantity">수량 *</label>
                            <input type="number" id="quantity" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="purchaseDate">구입일자 *</label>
                            <input type="date" id="purchaseDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="price">구입가격 (원)</label>
                            <input type="number" id="price" min="0">
                        </div>
                        <div class="form-group">
                            <label for="supplier">공급업체</label>
                            <input type="text" id="supplier">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="department">사용부서</label>
                            <input type="text" id="department">
                        </div>
                        <div class="form-group">
                            <label for="user">사용자</label>
                            <input type="text" id="user">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="location">위치</label>
                            <input type="text" id="location">
                        </div>
                        <div class="form-group">
                            <label for="status">상태 *</label>
                            <select id="status" required>
                                <option value="양호">양호</option>
                                <option value="보통">보통</option>
                                <option value="불량">불량</option>
                                <option value="고장">고장</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">비고</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px; border-top: 1px solid #bdc3c7; padding-top: 15px;">
                        <button type="button" class="btn" onclick="closeModal('equipmentModal')">취소</button>
                        <button type="submit" class="btn btn-success">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 대여 등록 모달 -->
    <div id="rentalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>새 대여 등록</h3>
                <button class="close" onclick="closeModal('rentalModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="rentalForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rentalCode">대여번호 *</label>
                            <input type="text" id="rentalCode" required>
                        </div>
                        <div class="form-group">
                            <label for="rentalEquipmentCode">비품번호 *</label>
                            <select id="rentalEquipmentCode" required>
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="borrower">대여자 *</label>
                            <input type="text" id="borrower" required>
                        </div>
                        <div class="form-group">
                            <label for="borrowerDept">부서 *</label>
                            <input type="text" id="borrowerDept" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rentalDate">대여일자 *</label>
                            <input type="date" id="rentalDate" required>
                        </div>
                        <div class="form-group">
                            <label for="returnDate">반납예정일 *</label>
                            <input type="date" id="returnDate" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="rentalPurpose">대여사유</label>
                        <textarea id="rentalPurpose" rows="3"></textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px; border-top: 1px solid #bdc3c7; padding-top: 15px;">
                        <button type="button" class="btn" onclick="closeModal('rentalModal')">취소</button>
                        <button type="submit" class="btn btn-success">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://pwvjjsweeazvzviknahe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3dmpqc3dlZWF6dnp2aWtuYWhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NTIxNzMsImV4cCI6MjA2ODIyODE3M30.GgtLKFeEg61xmC_Jrmf-qfbUNK5eVC82EO8chJJcIQc';
        
        // Supabase 클라이언트 초기화
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 전역 변수
        let equipmentData = [];
        let rentalData = [];
        let editingEquipmentId = null;
        let categoryList = ["전자기기", "사무기기", "가구", "소모품"];

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            await loadDataFromSupabase();
            updateStats();
            renderEquipmentTable();
            renderRentalTable();
            setCurrentDate();
            renderCategoryOptions();
        });

        function renderCategoryOptions() {
            const select = document.getElementById('category');
            select.innerHTML = '<option value="">선택하세요</option>';
            categoryList.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });

            // 필터에도 적용
            const filter = document.getElementById('categoryFilter');
            if (filter) {
                filter.innerHTML = '<option value="">전체 분류</option>';
                categoryList.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    filter.appendChild(option);
                });
            }
        }

        // 현재 날짜 설정
        function setCurrentDate() {
            const today = new Date();
            const formattedDate = today.getFullYear() + '년 ' + 
                                 String(today.getMonth() + 1).padStart(2, '0') + '월 ' + 
                                 String(today.getDate()).padStart(2, '0') + '일';
        }

        // Supabase에서 데이터 로드
        async function loadDataFromSupabase() {
            try {
                // 비품 데이터 로드
                const { data: equipment, error: equipmentError } = await supabaseClient
                    .from('equipment')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (equipmentError) throw equipmentError;
                equipmentData = equipment || [];

                // 대여 데이터 로드
                const { data: rentals, error: rentalError } = await supabaseClient
                    .from('rentals')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (rentalError) throw rentalError;
                rentalData = rentals || [];

                // 분류 데이터 로드
                const { data: categories, error: categoryError } = await supabaseClient
                    .from('categories')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (categoryError) throw categoryError;
                
                if (categories && categories.length > 0) {
                    categoryList = categories.map(cat => cat.name);
                }

                console.log('데이터 로드 완료:', { equipment: equipmentData.length, rentals: rentalData.length, categories: categoryList.length });
                
            } catch (error) {
                console.error('데이터 로드 중 오류:', error);
                alert('데이터를 불러오는 중 오류가 발생했습니다. 콘솔을 확인해주세요.');
                
                // 오류 시 로컬 스토리지에서 데이터 로드
                loadDataFromLocalStorage();
            }
        }

        // 로컬스토리지에서 데이터 로드 (백업용)
        function loadDataFromLocalStorage() {
            const savedEquipment = localStorage.getItem('equipmentData');
            const savedRentals = localStorage.getItem('rentalData');
            const savedCategories = localStorage.getItem('categoryList');

            if (savedEquipment) {
                equipmentData = JSON.parse(savedEquipment);
            }
            if (savedRentals) {
                rentalData = JSON.parse(savedRentals);
            }
            if (savedCategories) {
                categoryList = JSON.parse(savedCategories);
            }

            renderCategoryOptions();
        }

        // 비품 저장/업데이트
        async function saveEquipment(equipmentItem, isUpdate = false, originalId = null) {
            try {
                if (isUpdate && originalId) {
                    const { error } = await supabaseClient
                        .from('equipment')
                        .update(equipmentItem)
                        .eq('id', originalId);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient
                        .from('equipment')
                        .insert([equipmentItem]);
                    
                    if (error) throw error;
                }
                
                await loadDataFromSupabase();
                return true;
            } catch (error) {
                console.error('비품 저장 오류:', error);
                alert('비품 저장 중 오류가 발생했습니다: ' + error.message);
                return false;
            }
        }

        // 대여 저장
        async function saveRental(rentalItem) {
            try {
                const { error } = await supabaseClient
                    .from('rentals')
                    .insert([rentalItem]);
                
                if (error) throw error;
                
                await loadDataFromSupabase();
                return true;
            } catch (error) {
                console.error('대여 저장 오류:', error);
                alert('대여 저장 중 오류가 발생했습니다: ' + error.message);
                return false;
            }
        }

        // 분류 저장
        async function saveCategory(categoryName) {
            try {
                const { error } = await supabaseClient
                    .from('categories')
                    .insert([{ name: categoryName }]);
                
                if (error) throw error;
                
                await loadDataFromSupabase();
                return true;
            } catch (error) {
                console.error('분류 저장 오류:', error);
                alert('분류 저장 중 오류가 발생했습니다: ' + error.message);
                return false;
            }
        }

        // 비품 테이블 렌더링
        function renderEquipmentTable() {
            const tbody = document.getElementById('equipmentTableBody');
            
            if (equipmentData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="empty-state">등록된 비품이 없습니다. 새 비품을 등록해주세요.</td></tr>';
                return;
            }

            tbody.innerHTML = equipmentData.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.equipment_code}</td>
                    <td>${item.category}</td>
                    <td>${item.item_name}</td>
                    <td>${item.model || '-'}</td>
                    <td>${item.quantity}</td>
                    <td>${item.purchase_date}</td>
                    <td>${item.price ? item.price.toLocaleString() + '원' : '-'}</td>
                    <td>${item.department || '-'}</td>
                    <td>${item.user || '-'}</td>
                    <td>${item.location || '-'}</td>
                    <td><span class="status-${getStatusClass(item.status)}">${item.status}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-sm" onclick="editEquipment(${index})">수정</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEquipment(${index})">삭제</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // 대여 테이블 렌더링
        function renderRentalTable() {
            const tbody = document.getElementById('rentalTableBody');
            
            if (rentalData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">등록된 대여 기록이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = rentalData.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.rental_code}</td>
                    <td>${item.equipment_code}</td>
                    <td>${getEquipmentName(item.equipment_code)}</td>
                    <td>${item.borrower}</td>
                    <td>${item.department}</td>
                    <td>${item.rental_date}</td>
                    <td>${item.return_date}</td>
                    <td>${item.actual_return_date || '-'}</td>
                    <td>${item.actual_return_date ? '반납완료' : '대여중'}</td>
                    <td>
                        <div class="action-btns">
                            ${!item.actual_return_date ? `<button class="btn btn-sm btn-success" onclick="returnEquipment(${index})">반납</button>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteRental(${index})">삭제</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            updateRentalSelect();
        }

        // 통계 업데이트
        function updateStats() {
            const total = equipmentData.length;
            const good = equipmentData.filter(item => item.status === '양호').length;
            const needMaintenance = equipmentData.filter(item => item.status === '보통' || item.status === '불량').length;
            const totalValue = Math.round(equipmentData.reduce((sum, item) => sum + (item.price || 0), 0) / 10000);

            document.getElementById('totalEquipment').textContent = total;
            document.getElementById('goodCondition').textContent = good;
            document.getElementById('needMaintenance').textContent = needMaintenance;
            document.getElementById('totalValue').textContent = totalValue.toLocaleString();
        }

        // 유틸리티 함수들
        function getStatusClass(status) {
            switch(status) {
                case '양호': return 'good';
                case '보통': return 'fair';
                case '불량': return 'poor';
                case '고장': return 'poor';
                default: return 'good';
            }
        }

        function getEquipmentName(equipmentCode) {
            const equipment = equipmentData.find(item => item.equipment_code === equipmentCode);
            return equipment ? equipment.item_name : '알 수 없음';
        }

        function generateEquipmentCode() {
            const lastNumber = equipmentData.length > 0 ? 
                Math.max(...equipmentData.map(item => {
                    const match = item.equipment_code.match(/EQ-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                })) : 0;
            return `EQ-${String(lastNumber + 1).padStart(3, '0')}`;
        }

        function generateRentalCode() {
            const lastNumber = rentalData.length > 0 ? 
                Math.max(...rentalData.map(item => {
                    const match = item.rental_code.match(/R-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                })) : 0;
            return `R-${String(lastNumber + 1).padStart(3, '0')}`;
        }

        // 비품 등록/수정 폼 처리
        document.getElementById('equipmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                equipment_code: document.getElementById('equipmentCode').value,
                category: document.getElementById('category').value,
                item_name: document.getElementById('itemName').value,
                model: document.getElementById('model').value,
                quantity: parseInt(document.getElementById('quantity').value),
                purchase_date: document.getElementById('purchaseDate').value,
                price: parseInt(document.getElementById('price').value) || 0,
                supplier: document.getElementById('supplier').value,
                department: document.getElementById('department').value,
                user: document.getElementById('user').value,
                location: document.getElementById('location').value,
                status: document.getElementById('status').value,
                notes: document.getElementById('notes').value
            };

            let success = false;
            if (editingEquipmentId !== null) {
                // 수정
                const originalItem = equipmentData[editingEquipmentId];
                success = await saveEquipment(formData, true, originalItem.id);
                if (success) {
                    alert('비품 정보가 수정되었습니다.');
                }
            } else {
                // 신규 등록
                success = await saveEquipment(formData, false);
                if (success) {
                    alert('새 비품이 등록되었습니다.');
                }
            }
            
            if (success) {
                renderEquipmentTable();
                updateStats();
                closeModal('equipmentModal');
                resetEquipmentForm();
            }
        });

        // 대여 등록 폼 처리
        document.getElementById('rentalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                rental_code: document.getElementById('rentalCode').value,
                equipment_code: document.getElementById('rentalEquipmentCode').value,
                borrower: document.getElementById('borrower').value,
                department: document.getElementById('borrowerDept').value,
                rental_date: document.getElementById('rentalDate').value,
                return_date: document.getElementById('returnDate').value,
                purpose: document.getElementById('rentalPurpose').value,
                actual_return_date: null
            };

            const success = await saveRental(formData);
            if (success) {
                renderRentalTable();
                closeModal('rentalModal');
                resetRentalForm();
                alert('대여 등록이 완료되었습니다.');
            }
        });

        // 모달 관리
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            
            if (modalId === 'equipmentModal') {
                if (editingEquipmentId === null) {
                    document.getElementById('equipmentCode').value = generateEquipmentCode();
                }
            }
            
            if (modalId === 'rentalModal') {
                document.getElementById('rentalCode').value = generateRentalCode();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('rentalDate').value = today;
                updateRentalSelect();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            editingEquipmentId = null;
        }

        // 폼 리셋
        function resetEquipmentForm() {
            document.getElementById('equipmentForm').reset();
            document.getElementById('equipmentModalTitle').textContent = '새 비품 등록';
            editingEquipmentId = null;
        }

        function resetRentalForm() {
            document.getElementById('rentalForm').reset();
        }

        // 대여 가능 비품 목록 업데이트
        function updateRentalSelect() {
            const select = document.getElementById('rentalEquipmentCode');
            select.innerHTML = '<option value="">선택하세요</option>';
            
            // 대여 중이 아닌 비품만 표시
            const availableEquipment = equipmentData.filter(equipment => {
                const isRented = rentalData.some(rental => 
                    rental.equipment_code === equipment.equipment_code && !rental.actual_return_date
                );
                return !isRented && equipment.status === '양호';
            });

            availableEquipment.forEach(equipment => {
                const option = document.createElement('option');
                option.value = equipment.equipment_code;
                option.textContent = `${equipment.equipment_code} - ${equipment.item_name}`;
                select.appendChild(option);
            });
        }

        // 비품 수정
        function editEquipment(index) {
            const equipment = equipmentData[index];
            if (!equipment) return;

            editingEquipmentId = index;
            document.getElementById('equipmentModalTitle').textContent = '비품 정보 수정';
            
            // 폼에 기존 데이터 채우기
            document.getElementById('equipmentCode').value = equipment.equipment_code;
            document.getElementById('category').value = equipment.category;
            document.getElementById('itemName').value = equipment.item_name;
            document.getElementById('model').value = equipment.model || '';
            document.getElementById('quantity').value = equipment.quantity;
            document.getElementById('purchaseDate').value = equipment.purchase_date;
            document.getElementById('price').value = equipment.price || '';
            document.getElementById('supplier').value = equipment.supplier || '';
            document.getElementById('department').value = equipment.department || '';
            document.getElementById('user').value = equipment.user || '';
            document.getElementById('location').value = equipment.location || '';
            document.getElementById('status').value = equipment.status;
            document.getElementById('notes').value = equipment.notes || '';

            openModal('equipmentModal');
        }

        // 비품 삭제
        async function deleteEquipment(index) {
            if (!confirm('이 비품을 삭제하시겠습니까?')) return;
            
            try {
                const equipment = equipmentData[index];
                const { error } = await supabaseClient
                    .from('equipment')
                    .delete()
                    .eq('id', equipment.id);
                
                if (error) throw error;
                
                await loadDataFromSupabase();
                renderEquipmentTable();
                updateStats();
                alert('비품이 삭제되었습니다.');
                
            } catch (error) {
                console.error('비품 삭제 오류:', error);
                alert('비품 삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 대여 반납
        async function returnEquipment(index) {
            if (!confirm('이 비품을 반납 처리하시겠습니까?')) return;
            
            try {
                const rental = rentalData[index];
                const today = new Date().toISOString().split('T')[0];
                
                const { error } = await supabaseClient
                    .from('rentals')
                    .update({ actual_return_date: today })
                    .eq('id', rental.id);
                
                if (error) throw error;
                
                await loadDataFromSupabase();
                renderRentalTable();
                alert('반납 처리가 완료되었습니다.');
                
            } catch (error) {
                console.error('반납 처리 오류:', error);
                alert('반납 처리 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 대여 삭제
        async function deleteRental(index) {
            if (!confirm('이 대여 기록을 삭제하시겠습니까?')) return;
            
            try {
                const rental = rentalData[index];
                const { error } = await supabaseClient
                    .from('rentals')
                    .delete()
                    .eq('id', rental.id);
                
                if (error) throw error;
                
                await loadDataFromSupabase();
                renderRentalTable();
                alert('대여 기록이 삭제되었습니다.');
                
            } catch (error) {
                console.error('대여 기록 삭제 오류:', error);
                alert('대여 기록 삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 검색 및 필터
        function filterEquipment() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const filteredData = equipmentData.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.item_name.toLowerCase().includes(searchTerm) ||
                    (item.model && item.model.toLowerCase().includes(searchTerm)) ||
                    item.equipment_code.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;

                return matchesSearch && matchesCategory && matchesStatus;
            });

            // 필터된 데이터로 테이블 렌더링
            const tbody = document.getElementById('equipmentTableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="empty-state">검색 결과가 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredData.map((item, originalIndex) => {
                const index = equipmentData.indexOf(item);
                return `
                    <tr>
                        <td>${originalIndex + 1}</td>
                        <td>${item.equipment_code}</td>
                        <td>${item.category}</td>
                        <td>${item.item_name}</td>
                        <td>${item.model || '-'}</td>
                        <td>${item.quantity}</td>
                        <td>${item.purchase_date}</td>
                        <td>${item.price ? item.price.toLocaleString() + '원' : '-'}</td>
                        <td>${item.department || '-'}</td>
                        <td>${item.user || '-'}</td>
                        <td>${item.location || '-'}</td>
                        <td><span class="status-${getStatusClass(item.status)}">${item.status}</span></td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-sm" onclick="editEquipment(${index})">수정</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteEquipment(${index})">삭제</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 데이터 내보내기 (JSON)
        async function exportData() {
            try {
                await loadDataFromSupabase(); // 최신 데이터 로드
                
                const data = {
                    equipment: equipmentData,
                    rentals: rentalData,
                    categories: categoryList, 
                    exportDate: new Date().toISOString(),
                    version: '2.0'
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `비품관리_백업_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            } catch (error) {
                console.error('데이터 내보내기 오류:', error);
                alert('데이터 내보내기 중 오류가 발생했습니다.');
            }
        }

        // 데이터 가져오기 (JSON)
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.equipment && data.rentals) {
                        if (confirm('기존 데이터를 새로운 데이터로 교체하시겠습니까? (Supabase에 저장됩니다)')) {
                            
                            // 기존 데이터 삭제
                            await supabaseClient.from('equipment').delete().neq('id', 0);
                            await supabaseClient.from('rentals').delete().neq('id', 0);
                            await supabaseClient.from('categories').delete().neq('id', 0);
                            
                            // 새 데이터 삽입
                            if (data.equipment.length > 0) {
                                const equipmentToInsert = data.equipment.map(item => ({
                                    equipment_code: item.equipment_code || item.equipmentCode,
                                    category: item.category,
                                    item_name: item.item_name || item.itemName,
                                    model: item.model,
                                    quantity: item.quantity,
                                    purchase_date: item.purchase_date || item.purchaseDate,
                                    price: item.price,
                                    supplier: item.supplier,
                                    department: item.department,
                                    user: item.user,
                                    location: item.location,
                                    status: item.status,
                                    notes: item.notes
                                }));
                                await supabaseClient.from('equipment').insert(equipmentToInsert);
                            }
                            
                            if (data.rentals.length > 0) {
                                const rentalsToInsert = data.rentals.map(item => ({
                                    rental_code: item.rental_code || item.rentalCode,
                                    equipment_code: item.equipment_code || item.equipmentCode,
                                    borrower: item.borrower,
                                    department: item.department,
                                    rental_date: item.rental_date || item.rentalDate,
                                    return_date: item.return_date || item.returnDate,
                                    purpose: item.purpose,
                                    actual_return_date: item.actual_return_date || item.actualReturnDate
                                }));
                                await supabaseClient.from('rentals').insert(rentalsToInsert);
                            }
                            
                            if (data.categories && data.categories.length > 0) {
                                const categoriesToInsert = data.categories.map(name => ({ name }));
                                await supabaseClient.from('categories').insert(categoriesToInsert);
                            }

                            await loadDataFromSupabase();
                            renderEquipmentTable();
                            renderRentalTable();
                            updateStats();
                            alert('데이터를 성공적으로 가져왔습니다.');
                        }
                    } else {
                        alert('올바른 백업 파일이 아닙니다.');
                    }
                } catch (error) {
                    console.error('데이터 가져오기 오류:', error);
                    alert('파일을 읽을 수 없습니다: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // 전체 데이터 삭제
        async function clearAllData() {
            if (!confirm('모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
            if (!confirm('정말로 모든 비품 및 대여 데이터를 삭제하시겠습니까?')) return;
            
            try {
                await supabaseClient.from('equipment').delete().neq('id', 0);
                await supabaseClient.from('rentals').delete().neq('id', 0);
                
                equipmentData = [];
                rentalData = [];
                
                renderEquipmentTable();
                renderRentalTable();
                updateStats();
                alert('모든 데이터가 삭제되었습니다.');
                
            } catch (error) {
                console.error('데이터 삭제 오류:', error);
                alert('데이터 삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 인쇄 기능
        function printTable() {
            window.print();
        }

        // 모달 외부 클릭시 닫기
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        async function addCategory() {
            const input = document.getElementById('newCategory');
            const newCat = input.value.trim();
            if (!newCat) return alert("분류명을 입력해주세요.");
            if (categoryList.includes(newCat)) return alert("이미 존재하는 분류입니다.");

            const success = await saveCategory(newCat);
            if (success) {
                renderCategoryOptions();
                input.value = '';
                alert("새 분류가 추가되었습니다.");
            }
        }
    </script>
</body>
</html>